name: Build CLN for macOS

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    strategy:
      matrix:
        cln_version: ['v25.09.3', 'v25.12.1']
    
    steps:    
    - name: Verify Homebrew location
      run: |
        BREW_PATH=$(which brew)
        PKG_CONFIG_PATH=$(which pkg-config)
        echo "Brew location: $BREW_PATH"
        echo "pkg-config location: $PKG_CONFIG_PATH"
        
        if [[ "$BREW_PATH" != "/opt/homebrew/bin/brew" ]]; then
          echo "Error: Homebrew not at expected Apple Silicon location"
          exit 1
        fi
    
    - name: Install dependencies
      run: |
        brew install autoconf automake libtool python3 gnu-sed gettext \
          libsodium protobuf lowdown pkgconf openssl make sqlite
    
    - name: Set environment variables
      run: |
        echo 'export PATH="/opt/homebrew/opt/:$PATH"' >> $GITHUB_ENV
        echo 'export CPATH=/opt/homebrew/include' >> $GITHUB_ENV
        echo 'export LIBRARY_PATH=/opt/homebrew/lib' >> $GITHUB_ENV
        echo "/opt/homebrew/bin" >> $GITHUB_PATH
    
    - name: Install uv
      uses: astral-sh/setup-uv@v7
      with:
        python-version: 3.13
    
    - name: Clone CLN
      run: |
        git clone https://github.com/ElementsProject/lightning.git
        cd lightning
        git checkout ${{ matrix.cln_version }}
    
    - name: Build CLN
      run: |
        cd lightning
        export PATH="/opt/homebrew/opt/:$PATH"
        export CPATH=/opt/homebrew/include
        export LIBRARY_PATH=/opt/homebrew/lib
        export RUST_PROFILE=release
        
        # Initialize Python environment
        uv sync --all-extras --all-groups --frozen
        
        # Configure
        ./configure --prefix=$HOME/cln-install
        
        # Verify no Intel compatibility issues
        if grep -r "/usr/local" config.log; then
          echo "Error: Intel compatibility dependency detected in /usr/local"
          exit 1
        fi
        
        # Build
        uv run gmake -j$(sysctl -n hw.ncpu)
        
        # Install to prefix
        uv run gmake install
    
    - name: Verify installation
      run: |
        $HOME/cln-install/bin/lightningd --version
        $HOME/cln-install/bin/lightning-cli --version
    
    - name: Create tarball
      run: |
        cd $HOME
        tar -czf cln-macos-${{ matrix.cln_version }}.tar.gz -C cln-install .
        
    - name: Create Release
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        VERSION=${{ matrix.cln_version }}
        cd lightning
        
        # Create release if it doesn't exist
        gh release create $VERSION --repo ${{ github.repository }} \
          --title "CLN $VERSION for macOS Apple Silicon" \
          --notes "Pre-built Core Lightning $VERSION binaries for macOS Apple Silicon (arm64)" \
          || true
        
        # Upload the artifact
        gh release upload $VERSION $HOME/cln-macos-$VERSION.tar.gz \
          --repo ${{ github.repository }} --clobber
